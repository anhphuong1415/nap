<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="Decription" content="BLOCKLY TRY OUT">
    <link rel="stylesheet" type="text/css" href="webview.css">
    <link rel="stylesheet" href="toolbox_style.css">
    <link rel="stylesheet" href="Libs/css/bootstrap.css">
    <script src="acorn_interpreter.js"></script>
    <script src="node_modules/blockly/blockly_compressed.js"></script>
    <script src="node_modules/blockly/blocks_compressed.js"></script>
    <script src="node_modules/blockly/javascript_compressed.js"></script>
    <script src="toolbox_standard.js"></script>
    <script src="node_modules/blockly/msg/vi.js"></script>
    <script src="CustomBlockForRange1.js"></script>
    <script src="wait_block.js"></script>
    <script src="Libs/js/jQuerry.js"></script>
    <script src="Libs/js/bootstrap.bundle.js"></script>
    <script>
        var goog = {
            provide: function() {},
            require: function() {}
        };
    </script>
    <script src="CustomField/js/field_pitch.js"></script>
    <script src="CustomField/js/field_calculate.js"></script>
    <script src="CustomField/js/field_turtle.js"></script>
    <script src="CustomField/js/field_velocity.js"></script>
    <script src="CustomField/js/field_matrix.js"></script>
    <script src="CustomField/js/field_ring.js"></script>
    <script src="GenneratorForRange.js"></script>
    <script src="custom_category_es6.js"></script>
    <script src="toolbox_label_es6.js"></script>
    <script src="theme.js"></script>

    <link rel="stylesheet" type="text/css" href="CustomField/css/pitch.css">
    <link rel="stylesheet" type="text/css" href="CustomField/css/turtle.css">
    <link rel="stylesheet" type="text/css" href="CustomField/css/calculate.css">
    <link rel="stylesheet" type="text/css" href="CustomField/css/velocity.css">
    <link rel="stylesheet" type="text/css" href="CustomField/css/matrixLed.css">
    <link rel="stylesheet" type="text/css" href="CustomField/css/ringled.css">
</head>

<body>

    <div id="snackbar">
        <svg id="SNACK_BAR" viewBox="0 0 141.73 141.73"><defs><style>.cls-1{fill:#dcffff;}.cls-2{fill:#56aab7;}.cls-3{fill:#e9649f;}.cls-4{fill:url(#radial-gradient);}.cls-5{fill:#91d3e8;}.cls-6{fill:#fff;stroke:#1f3f71;stroke-miterlimit:10;stroke-width:3px;}.cls-7{fill:#1f3f71;}.cls-8{fill:#ef8bb7;}</style><radialGradient id="radial-gradient" cx="70.96" cy="89.9" r="45.13" gradientUnits="userSpaceOnUse"><stop offset="0.18" stop-color="#c2e6f2"/><stop offset="0.94" stop-color="#c0e6f2"/></radialGradient></defs><title>Draw Icon</title><circle class="cls-1" cx="70.87" cy="70.87" r="70.87"/><path class="cls-2" d="M69,2.87l-1,.08a32.29,32.29,0,0,0-16.1,6.3A25.85,25.85,0,0,0,49,11.6s3,3.45,3.22,3.7l.12.13.59-.5A27,27,0,0,1,71,8.48a25.91,25.91,0,0,1,8,1.37,25.05,25.05,0,0,1,3.52,1.45,28.16,28.16,0,0,1,5.93,4l.21.19,1.7-1.93,1.69-1.92-.21-.19a39.74,39.74,0,0,0-5.8-4.21c-.9-.53-2.86-1.51-3.84-1.93a30.44,30.44,0,0,0-10-2.4C71.56,2.84,69.68,2.83,69,2.87Z"/><path class="cls-2" d="M69.05,14a22.2,22.2,0,0,0-12.66,5.29,1.35,1.35,0,0,0-.35.36c0,.08,3.47,4,3.52,4a1.2,1.2,0,0,0,.32-.23,17.09,17.09,0,0,1,5.58-3.08A17.06,17.06,0,0,1,74.33,20a16.81,16.81,0,0,1,6.51,3.2,5,5,0,0,0,.58.44s3.55-4,3.55-4a14.09,14.09,0,0,0-1.46-1.21A21.79,21.79,0,0,0,72.26,14,31.43,31.43,0,0,0,69.05,14Z"/><path class="cls-2" d="M69.31,25a11.39,11.39,0,0,0-4.83,1.8,10.35,10.35,0,0,0-1.27,1c-.05.06.44.65,3.51,4.15l3.67,4.18.1.11,3.58-4.09,3.67-4.19.11-.12-.46-.35A11.07,11.07,0,0,0,69.31,25Z"/><path class="cls-3" d="M67.17,39.73h7.6A10.66,10.66,0,0,1,85.42,50.39V64a0,0,0,0,1,0,0H56.51a0,0,0,0,1,0,0V50.39A10.66,10.66,0,0,1,67.17,39.73Z"/><path class="cls-4" d="M50.39,57.06H91.54a34.15,34.15,0,0,1,34.15,34.15v17.25a14.27,14.27,0,0,1-14.27,14.27H30.51a14.27,14.27,0,0,1-14.27-14.27V91.21A34.15,34.15,0,0,1,50.39,57.06Z"/><circle class="cls-5" cx="37.88" cy="87.76" r="16.79"/><circle class="cls-6" cx="32.34" cy="89.9" r="18.47"/><circle class="cls-5" cx="103.63" cy="88.35" r="16.79"/><circle class="cls-6" cx="109.58" cy="89.9" r="18.47"/><circle class="cls-7" cx="32.34" cy="89.9" r="4.2"/><circle class="cls-7" cx="109.58" cy="89.9" r="4.2"/><path class="cls-7" d="M91.8,104.14c0,9.16-9.33,16.59-20.84,16.59s-20.83-7.43-20.83-16.59"/><path class="cls-5" d="M59.3,117.9a25.35,25.35,0,0,0,23.28,0c-1.74-3.7-6.39-4.92-11.73-4.92S61,114.2,59.3,117.9Z"/><ellipse class="cls-8" cx="64.92" cy="48.75" rx="6.22" ry="3.55" transform="translate(-8.7 82.98) rotate(-61.83)"/></svg>
        <!-- <iframe id="snackbarIcon" src="Utils/ToolboxIcon/Cảm biến.svg"></iframe> -->
        <div id="innerSnackbackText"> SHOW TEXT HERE</div>
    </div>

    <div id="bodyDiv" style="width: 100%; height: 100vh">
        <xml id="toolbox" style="display: none">
            <category name="Di chuyển" categorystyle="list_category">
                <block type="robot_move">
                    <field name="Direction">Tiến</field>
                    <field name="Velocity">0</field>
                    <field name="Duration">0</field>
                </block>
                <block type="servo">
                    <field name="Servo_Select">Servo_1</field>
                    <field name="Angle">90</field>
                </block>
                <block type="motorselect">
                    <field name="MotorSelect">Left</field>
                    <field name="velocity">1</field>
                    <field name="duration">1</field>
                </block>
                <block type="stop_move"></block>
            </category>
            <category name="Biểu diễn" categorystyle="list_category">
                <block type="playmusicnote">
                    <field name="Note">C</field>
                    <field name="Duration">0</field>
                </block>
                <block type="ringled">
                    <field name="ringLedModule">Port 1</field>
                    <field name="Led_1">#ff6666</field>
                    <field name="Led_2">#990000</field>
                    <field name="Led_3">#009900</field>
                    <field name="Led_4">#009900</field>
                    <field name="Led_5">#3366ff</field>
                    <field name="Led_6">#000099</field>
                    <field name="Led_7">#cc33cc</field>
                    <field name="Led_8">#66ffff</field>
                    <field name="Led_9">#ff99ff</field>
                    <field name="Led_10">#33cc00</field>
                    <field name="Led_11">#33ffff</field>
                    <field name="Led_12">#ffff66</field>
                </block>
                <block type="playwithmatrix"></block>
                <block type="rgb_led">
                    <field name="color_left">#00cccc</field>
                    <field name="color_right">#00cccc</field>
                    <field name="duration">0</field>
                </block>
                <block type="turnoffledrbg">
                </block>
            </category>
            <category name="Cảm biến" categorystyle="list_category">
                <block type="srf05">
                    <field name="port">Port 1</field>
                </block>
                <block type="light_sensor">
                    <field name="Port">Port 1</field>
                </block>
                <block type="colorsensor">
                    <field name="Port">Port 1</field>
                </block>
                <block type="sound_sensor">
                    <field name="Port">Port 1</field>
                </block>
                <block type="path_detecter">
                    <field name="Port">Port 1</field>
                    <field name="side">bên trái</field>
                    <field name="color">màu trắng</field>
                </block>
            </category>
            <category name="Tính toán" categorystyle="list_category">
                <block type="logic_operation">
                    <field name="OP">AND</field>
                </block>
                <block type="math_number">
                    <field name="NUM">0</field>
                </block>
                <block type="math_arithmetic">
                    <field name="OP">ADD</field>
                    <value name="A">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                    <value name="B">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                </block>
                <block type="logic_compare">
                    <field name="OP">EQ</field>
                </block>
            </category>
            <category name="Điều khiển" categorystyle="list_category">
                <block type="if_block"></block>
                <block type="stop_move"></block>
                <block type="loop">
                    <field name="NAME">0</field>
                </block>
                <block type="break_continue_loop">
                    <field name="action">nhảy vòng lặp</field>
                </block>
                <block type="if1"></block>
                <block type="wait_seconds"></block>
                <block type="while"></block>
            </category>
            <category name="Hàm" categorystyle="list_category">
                <block type="create_function">
                    <field name="Function_name">di chuyển</field>
                </block>
            </category>
            <category name="Dữ liệu" custom="VARIABLE" categorystyle="list_category"></category>
        </xml>

        <xml id="startBlocks" style="display: none">
            <!-- <block type="dummy_play_block" x="400" y="50"></block> -->
            <block type="field_ring" x="400" y="50"></block>
        </xml>
        <!-- <textarea id="codeSpaceText" style="height: 100vh; width: 50vw;">
        </textarea> -->
        <div id="headerDiv_">
            <div id="tabName"></div>
        </div>
        <div id="blocklyDiv">
        </div>
        <div id="functionButton">
            <button id="RUN" onclick="handleGenCode()"></button>
            <button id="SAVE" onclick="handleSave()"></button>
            <button id="BLUETOOTH" onclick="handleBT()"></button>
        </div>
        <!-- <div style="margin-left: 50%; height: 600px;">
            <textarea rows="40" cols="80" id="codeSpaceText"></textarea>
        </div> -->


        <script>
            var workspacePlayground = Blockly.inject('blocklyDiv', {
                media: 'media/',
                toolbox: document.getElementById('toolbox'),
                collapse: false,
                comments: true,
                disable: true,
                maxBlocks: Infinity,
                trashcan: true,
                horizontalLayout: false,
                toolboxPosition: 'start',
                css: true,
                rtl: false,
                scrollbars: true,
                sounds: true,
                oneBasedIndex: true,
                zoom: {
                    controls: true,
                    wheel: true,
                    startScale: 0.5,
                    maxScale: 3,
                    minScale: 0.3,
                    scaleSpeed: 1.2
                },
                theme: Blockly.Themes.Halloween
            });
            Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'),
                workspacePlayground);
            var myInterpreter = null;
            var nextStep;
            var runButton = document.getElementById('RUN');
            var x = document.getElementById("snackbar");

            Blockly.JavaScript.addReservedWords('exit');

            function initApi(interpreter, globalObject) {
                // Add an API function for the prompt() block.
                var wrapper = function(text) {
                    text = text ? text.toString() : '';
                    return interpreter.createPrimitive(prompt(text));
                };
                interpreter.setProperty(globalObject, 'prompt',
                    interpreter.createNativeFunction(wrapper));

                // Add an API for the wait block.  See wait_block.js
                initInterpreterWaitForSeconds(interpreter, globalObject);

                // Add an API function for highlighting blocks.
                var wrapper = function(id) {
                    return workspacePlayground.highlightBlock(id);
                };
                interpreter.setProperty(globalObject, 'highlightBlock',
                    interpreter.createNativeFunction(wrapper));

                var wrapper = function(action, port, m_module, duration, dirMove, additionModule, value1, value2, value3, value4, value5, value6, value7, value8, value9, value10, value11, value12) {
                    return sendCmd(action, port, m_module, duration, dirMove, additionModule, value1, value2, value3, value4, value5, value6, value7, value8, value9, value10, value11, value12);
                }
                interpreter.setProperty(globalObject, 'sendCmd',
                    interpreter.createNativeFunction(wrapper));

                var wrapper = function() {
                    return interpreter.createPrimitive(getValue());
                }
                interpreter.setProperty(globalObject, 'getValue',
                    interpreter.createNativeFunction(wrapper));
            }

            function getValue() {
                return Android.GetValue();
            }

            Blockly.JavaScript.addReservedWords('exit');

            function sendCmd(action, port, m_module, duration, dirMove, additionModule, value1, value2, value3, value4, value5, value6, value7, value8, value9, value10, value11, value12) {
                var out = Android.sendCmd(action, port, m_module, duration, dirMove, additionModule, value1, value2, value3, value4, value5, value6, value7, value8, value9, value10, value11, value12);

                if (m_module == 1) {
                    showSensor("Khoảng cách: " + getValue());
                } else if (m_module == 2) {
                    showSensor("Làn đường: " + getValue());
                } else if (m_module == 3) {
                    showSensor("Độ sáng: " + getValue());
                } else if (m_module == 4) {
                    showSensor("Màu: " + getValue());
                } else if (m_module == 10) {
                    showSensor("Âm thanh: " + getValue());
                }
                return out;
            }

            var highlightPause = false;
            var latestCode = '';

            function highlightBlock(id) {
                workspacePlayground.highlightBlock(id);
                highlightPause = true;
            }

            function resetStepUi() {
                workspacePlayground.highlightBlock(null);
                highlightPause = false;
                clearShowSensor();
            }

            function resetInterpreter() {
                myInterpreter = null;
                if (nextStep) {
                    clearTimeout(nextStep);
                    nextStep = null;
                }
            }

            var stopButton = Boolean(9 > 10);

            function stopFunction() {
                if (nextStep) {
                    clearTimeout(nextStep);
                    nextStep = null;
                }
                resetInterpreter();
                resetStepUi();
                Android.finishCmd();
            }

            function handleGenCode() {
                stopButton = !Boolean(stopButton);
                console.log(stopButton.toString());
                console.log(latestCode);
                if (Boolean(stopButton)) {
                    document.getElementById("RUN").style.background = "url(Utils/Icon/svg/Stop.svg)";
                    resetStepUi();
                    if (!myInterpreter) {
                        // First statement of this code.
                        // Clear the program output.
                        myInterpreter = new Interpreter(latestCode, initApi);
                    }
                    setTimeout(function() {
                        nextStep = function() {
                            if (myInterpreter.step()) {
                                if (Boolean(stopButton)) {
                                    setTimeout(nextStep, 10);
                                    return;
                                } else {
                                    document.getElementById("RUN").style.background = "url(Utils/Icon/svg/Start.svg)";
                                    stopFunction();
                                }
                            } else {
                                stopButton = Boolean(9 > 10);
                                resetInterpreter();
                                resetStepUi();
                                document.getElementById("RUN").style.background = "url(Utils/Icon/svg/Start.svg)";
                                Android.finishCmd();
                            }
                        }
                        nextStep();
                        //     if (myInterpreter) {
                        //         var hasMore = myInterpreter.run();
                        //         if (hasMore) {
                        //             if (Boolean(stopButton)) {
                        //                 setTimeout(nextStep, 10);
                        //             } else {
                        //                 stopFunction();
                        //             }
                        //         } else {
                        //             stopButton = Boolean(9 > 10);
                        //             resetInterpreter();
                        //             resetStepUi();
                        //         }
                        //     }
                        // };
                        // nextStep();
                    }, 1);
                    return;
                } else {
                    document.getElementById("RUN").style.background = "url(Utils/Icon/svg/Start.svg)";
                    Android.finishCmd();
                }
            }

            function handleTmpSave() {
                let workspace = Blockly.getMainWorkspace();
                if (typeof(Storage) !== "undefined") {
                    localStorage.removeItem("storageTmp");
                    var xml = Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace());
                    localStorage.setItem("storageTmp", Blockly.Xml.domToText(xml));
                } else {}
            }

            function handleTmpLOAD() {
                let workspace = Blockly.getMainWorkspace();
                workspace.clear();
                if (typeof(Storage) !== "undefined") {
                    // workspace.clear();
                    if (localStorage.storageTmp != null) {
                        // workspace.clear();
                        var xml = Blockly.Xml.textToDom(localStorage.getItem("storageTmp"));
                        Blockly.Xml.domToWorkspace(xml, workspace);
                    }
                }
            }

            function handleSave() {
                let workspace = Blockly.getMainWorkspace();
                if (typeof(Storage) !== "undefined") {
                    localStorage.removeItem("storage");
                    var xml = Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace());
                    localStorage.setItem("storage", Blockly.Xml.domToText(xml));
                } else {
                    // Sorry! No Web Storage support..
                }
            }

            function handleLOAD() {
                let workspace = Blockly.getMainWorkspace();
                if (typeof(Storage) !== "undefined") {
                    if (localStorage.storage != null) {
                        workspace.clear();
                        var xml = Blockly.Xml.textToDom(localStorage.getItem("storage"));
                        Blockly.Xml.domToWorkspace(xml, workspace);
                    }
                }
            }

            function handleBT() {
                Android.connectBluetooth();
            }

            function showSensor(showString) {
                // Get the snackbar DIV
                if (x.className != "show") {
                    x.className = "show";
                }
                // Add the "show" class to DIV
                document.getElementById("innerSnackbackText").innerHTML = showString;

                return 0;
            }

            function clearShowSensor() {
                if (x.className == "show") {
                    // After 3 seconds, remove the show class from DIV
                    setTimeout(function() {
                        x.className = x.className.replace("show", "");
                    }, 20);
                }
            }

            function changeSnackBarIcon(svgAddress) {
                // Get the snackbar DIV
                var x = document.getElementById("snackbarIcon");
                x.src = svgAddress;
            }

            function handleStop() {
                clearInterval(runID);
                runID = null;
            }

            function generateCodeAndLoadIntoInterpreter() {
                // Generate JavaScript code and parse it.
                Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
                Blockly.JavaScript.addReservedWords('highlightBlock');
                latestCode = Blockly.JavaScript.workspaceToCode(workspacePlayground);
                resetStepUi();
            }

            generateCodeAndLoadIntoInterpreter();
            workspacePlayground.addChangeListener(function(event) {
                if (!event.isUiEvent) {
                    // Something changed. Parser needs to be reloaded.
                    resetInterpreter();
                    generateCodeAndLoadIntoInterpreter();
                }
            });
            // document.getElementById('genCodeCommand').addEventListener('click', handleGenCode)
        </script>
    </div>
</body>

</html>